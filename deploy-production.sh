#!/bin/bash

echo "๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต ะฝะฐ ะฟัะพะดะฐะบัะตะฝ ัะตัะฒะตัะต..."

# ะัะพะฒะตััะตะผ, ััะพ ะผั ะฒ ะฟัะฐะฒะธะปัะฝะพะน ะดะธัะตะบัะพัะธะธ
if [ ! -f "package.json" ]; then
    echo "โ ะคะฐะนะป package.json ะฝะต ะฝะฐะนะดะตะฝ. ะฃะฑะตะดะธัะตัั, ััะพ ะฒั ะฒ ะบะพัะฝะตะฒะพะน ะฟะฐะฟะบะต ะฟัะพะตะบัะฐ."
    exit 1
fi

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะตะดัะดััะธะต ะฟัะพัะตััั
echo "๐ ะััะฐะฝะพะฒะบะฐ ะฟัะตะดัะดััะธั ะฟัะพัะตััะพะฒ..."
pkill -f "node.*start-production.js" || true
pkill -f "node.*server.js" || true
sleep 2

# ะัะพะฒะตััะตะผ Node.js
echo "๐ฆ ะัะพะฒะตัะบะฐ Node.js..."
if ! command -v node &> /dev/null; then
    echo "โ Node.js ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ..."
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    sudo apt-get install -y nodejs
fi

echo "โ Node.js ะฒะตััะธั: $(node --version)"
echo "โ npm ะฒะตััะธั: $(npm --version)"

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ
echo "๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
npm install

# ะัะพะฒะตััะตะผ ะฟะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะดะฐะฝะฝัั
echo "๐ ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั..."
node -e "
const db = require('./database');
db.initializeDatabase().then(result => {
    if (result) {
        console.log('โ ะะฐะทะฐ ะดะฐะฝะฝัั ะฟะพะดะบะปััะตะฝะฐ');
        process.exit(0);
    } else {
        console.log('โ ะัะธะฑะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั');
        process.exit(1);
    }
}).catch(err => {
    console.error('โ ะัะธะฑะบะฐ:', err.message);
    process.exit(1);
});
"

if [ $? -ne 0 ]; then
    echo "โ ะะต ัะดะฐะปะพัั ะฟะพะดะบะปััะธัััั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั"
    echo "๐ก ะัะพะฒะตัััะต ะฝะฐัััะพะนะบะธ ะฒ database.js"
    exit 1
fi

# ะะฐะฟะพะปะฝัะตะผ ะฑะฐะทั ัะตััะพะฒัะผะธ ะดะฐะฝะฝัะผะธ
echo "๐ฑ ะะฐะฟะพะปะฝะตะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั ัะตััะพะฒัะผะธ ะดะฐะฝะฝัะผะธ..."
node seed-data.js

# ะะฐะฟััะบะฐะตะผ ะฟัะพะดะฐะบัะตะฝ ัะตัะฒะตั
echo "๐ ะะฐะฟััะบ ะฟัะพะดะฐะบัะตะฝ ัะตัะฒะตัะฐ..."
nohup node start-production.js > server.log 2>&1 &
SERVER_PID=$!

# ะะดะตะผ ะฝะตะผะฝะพะณะพ ะธ ะฟัะพะฒะตััะตะผ, ััะพ ัะตัะฒะตั ะทะฐะฟัััะธะปัั
sleep 3

if kill -0 $SERVER_PID 2>/dev/null; then
    echo "โ ะกะตัะฒะตั ะทะฐะฟััะตะฝ (PID: $SERVER_PID)"
    echo "๐ ะะพะณะธ ัะตัะฒะตัะฐ: tail -f server.log"
    echo "๐ API ะดะพัััะฟะตะฝ: http://89.104.66.62:3001/api/"
    echo "๐งช ะขะตัั API: http://89.104.66.62:3001/api/test"
    echo "๐ ะกัะฐััั ะะ: http://89.104.66.62:3001/api/db-status"
    echo ""
    echo "๐ค ะะฐะฝะฝัะต ะดะปั ะฒัะพะดะฐ:"
    echo "   ะะดะผะธะฝะธัััะฐัะพั: admin / admin123"
    echo "   ะะพะปัะทะพะฒะฐัะตะปั: user / user123"
    echo ""
    echo "๐ ะะปั ะพััะฐะฝะพะฒะบะธ ัะตัะฒะตัะฐ: kill $SERVER_PID"
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ"
    echo "๐ ะัะพะฒะตัััะต ะปะพะณะธ: cat server.log"
    exit 1
fi 