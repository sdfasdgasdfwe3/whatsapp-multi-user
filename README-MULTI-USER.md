# Многопользовательская система WhatsApp Web

## Обзор

Система была обновлена для поддержки множественных пользователей с индивидуальными WhatsApp сессиями. Каждый пользователь может иметь свою собственную сессию WhatsApp, независимую от других пользователей.

## Основные изменения

### 1. Удалены ненужные файлы
- `server-multi.js` - удален (использовал JSON файл вместо MySQL)
- `database.json` - удален (заменен на MySQL)

### 2. Обновлен `server.js`
- Добавлена поддержка множественных WhatsApp клиентов
- Каждый пользователь имеет свой собственный клиент WhatsApp
- Добавлена аутентификация с JWT токенами
- Добавлены роли пользователей (admin/user)

### 3. Обновлен `database.js`
- Добавлены функции для управления пользователями
- Все функции работают с MySQL базой данных

## API Endpoints

### Аутентификация
- `POST /api/auth/register` - Регистрация пользователя
- `POST /api/auth/login` - Вход пользователя

### WhatsApp (для каждого пользователя)
- `GET /api/whatsapp/status/:userId` - Статус подключения
- `GET /api/whatsapp/qr/:userId` - Получить QR-код
- `POST /api/whatsapp/send/:userId` - Отправить сообщение
- `GET /api/whatsapp/chats/:userId` - Получить чаты
- `POST /api/whatsapp/disconnect/:userId` - Отключить WhatsApp
- `POST /api/whatsapp/restart/:userId` - Перезапустить клиент
- `POST /api/whatsapp/clear-session/:userId` - Очистить сессию

### Продукты
- `GET /api/products` - Получить все продукты
- `POST /api/products` - Создать продукт (только админы)
- `PUT /api/products/:id` - Обновить продукт (только админы)
- `DELETE /api/products/:id` - Удалить продукт (только админы)

### Статьи
- `GET /api/articles` - Получить все статьи
- `POST /api/articles` - Создать статью (только админы)
- `PUT /api/articles/:id` - Обновить статью (только админы)
- `DELETE /api/articles/:id` - Удалить статью (только админы)

### Пользователи (только для админов)
- `GET /api/admin/users` - Получить всех пользователей
- `PUT /api/admin/users/:userId/role` - Изменить роль пользователя
- `DELETE /api/admin/users/:userId` - Удалить пользователя

### Профиль пользователя
- `GET /api/user/profile` - Получить профиль (требует аутентификации)
- `PUT /api/user/profile` - Обновить профиль (требует аутентификации)

### Статистика (только для админов)
- `GET /api/admin/stats` - Статистика системы
- `GET /api/admin/whatsapp-sessions` - Активные WhatsApp сессии

## Многопоточность и производительность

### Особенности реализации:
1. **Пул соединений MySQL** - Настроен для эффективной работы с множественными запросами
2. **Индивидуальные WhatsApp клиенты** - Каждый пользователь имеет свой клиент
3. **Асинхронная обработка** - Все операции выполняются асинхронно
4. **Управление памятью** - Клиенты автоматически очищаются при отключении

### Рекомендации для продакшена:
1. **Ограничение количества клиентов** - Добавить лимит на количество активных клиентов
2. **Мониторинг ресурсов** - Использовать API `/api/admin/stats` для мониторинга
3. **Автоматическая очистка** - Добавить периодическую очистку неактивных клиентов
4. **Балансировка нагрузки** - При большом количестве пользователей рассмотреть кластеризацию

## Запуск системы

```bash
# Установка зависимостей
npm install

# Запуск сервера
npm run server

# Или напрямую
node server.js
```

## Структура базы данных

### Таблица users
- `id` - Уникальный идентификатор
- `username` - Имя пользователя (уникальное)
- `password` - Хешированный пароль
- `fullName` - Полное имя
- `email` - Email
- `role` - Роль (user/admin)
- `points` - Баллы пользователя
- `created_at` - Дата создания
- `updated_at` - Дата обновления

### Таблица products
- `id` - Уникальный идентификатор
- `name` - Название продукта
- `description` - Описание
- `price` - Цена
- `points` - Баллы за покупку
- `image` - URL изображения
- `created_at` - Дата создания
- `updated_at` - Дата обновления

### Таблица articles
- `id` - Уникальный идентификатор
- `title` - Заголовок статьи
- `content` - Содержание
- `author` - Автор
- `image` - URL изображения
- `created_at` - Дата создания
- `updated_at` - Дата обновления

### Таблицы для чатов и сообщений
- `chats` - Чаты пользователей
- `messages` - Сообщения в чатах

## Безопасность

1. **JWT токены** - Для аутентификации пользователей
2. **Хеширование паролей** - Используется bcrypt
3. **Роли пользователей** - Разграничение доступа
4. **SQL инъекции** - Защищены через параметризованные запросы
5. **CORS** - Настроен для безопасных запросов

## Мониторинг

Используйте API endpoints для мониторинга:
- `/api/admin/stats` - Общая статистика
- `/api/admin/whatsapp-sessions` - Активные сессии
- `/api/db-status` - Статус базы данных

## Устранение неполадок

### Проблема: Ошибка 500 при добавлении продукта
**Решение:** Проверьте логи сервера и убедитесь, что база данных подключена корректно.

### Проблема: WhatsApp клиент не подключается
**Решение:** 
1. Проверьте интернет-соединение
2. Убедитесь, что QR-код отсканирован
3. Попробуйте перезапустить клиент через API

### Проблема: Медленная работа при множественных пользователях
**Решение:**
1. Увеличьте лимиты пула соединений MySQL
2. Добавьте кэширование
3. Рассмотрите горизонтальное масштабирование 